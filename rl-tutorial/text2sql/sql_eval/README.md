# Text2SQL è¯„ä¼°ç³»ç»Ÿ

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„Text2SQLè¯„ä¼°ç³»ç»Ÿï¼Œç”¨äºè¯„ä¼°å¤§è¯­è¨€æ¨¡å‹åœ¨SQLç”Ÿæˆä»»åŠ¡ä¸Šçš„æ€§èƒ½ã€‚è¯¥ç³»ç»Ÿæ”¯æŒå¤šè½®å¯¹è¯ã€å·¥å…·è°ƒç”¨ã€å¤šè½¨è¿¹ç”Ÿæˆå’Œå…¨é¢çš„ç»“æœåˆ†æã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ”„ **å¤šè½®å¯¹è¯ç®¡ç†**: æ”¯æŒä¸SGLangæœåŠ¡å™¨çš„å¤šè½®å¯¹è¯äº¤äº’
- ğŸ› ï¸ **SQLå·¥å…·è°ƒç”¨**: é›†æˆSQLæ‰§è¡Œå·¥å…·ï¼Œæ”¯æŒå®é™…æ•°æ®åº“æŸ¥è¯¢
- ğŸ¯ **å¤šè½¨è¿¹ç”Ÿæˆ**: æ”¯æŒä¸ºæ¯ä¸ªæ ·æœ¬ç”Ÿæˆå¤šæ¡è½¨è¿¹ï¼Œæä¾›æ ·æœ¬çº§åˆ«å’Œè½¨è¿¹çº§åˆ«çš„å‡†ç¡®ç‡
- âš™ï¸ **æ¨¡å‹å‚æ•°é…ç½®**: æ”¯æŒçµæ´»é…ç½®æ¨¡å‹åç§°ã€æ¸©åº¦ã€æœ€å¤§tokenæ•°ç­‰å‚æ•°
- ğŸ“Š **å…¨é¢è¯„ä¼°**: å¤šç»´åº¦è¯„ä¼°æŒ‡æ ‡ï¼ŒåŒ…æ‹¬æ‰§è¡Œå‡†ç¡®ç‡ã€æ ¼å¼å‡†ç¡®ç‡ç­‰
- ğŸ“ˆ **ç»“æœåˆ†æ**: è¯¦ç»†çš„é”™è¯¯åˆ†æã€æ€§èƒ½åˆ†æå’Œæ”¹è¿›å»ºè®®
- ğŸš€ **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šå¹¶å‘è¯·æ±‚ï¼Œæé«˜è¯„ä¼°æ•ˆç‡
- ğŸ“ **å¤šæ•°æ®æº**: æ”¯æŒSynSQLã€Spiderã€BIRDç­‰å¤šç§æ•°æ®æº

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¯„ä¼°æ•°æ®é›†     â”‚    â”‚   SGLang Server â”‚    â”‚   SQLæ•°æ®åº“     â”‚
â”‚   - é—®é¢˜        â”‚    â”‚   - æ¨¡å‹æ¨ç†    â”‚    â”‚   - æ‰§è¡Œç¯å¢ƒ    â”‚
â”‚   - æ•°æ®åº“ä¿¡æ¯   â”‚â”€â”€â”€â–ºâ”‚   - å¤šè½®å¯¹è¯    â”‚â—„â”€â”€â–ºâ”‚   - ç»“æœéªŒè¯    â”‚
â”‚   - Golden SQL â”‚    â”‚   - å·¥å…·è°ƒç”¨    â”‚    â”‚   - æ€§èƒ½æµ‹è¯•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è¯„ä¼°è„šæœ¬                                    â”‚
â”‚  - Promptæ„é€   - è¯·æ±‚ç®¡ç†  - ç»“æœè§£æ  - æ€§èƒ½è¯„ä¼°  - æŠ¥å‘Šç”Ÿæˆ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

## å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡æ•°æ®

ç¡®ä¿ä½ æœ‰ä»¥ä¸‹æ•°æ®ï¼š
- è¯„ä¼°æ•°æ®é›†æ–‡ä»¶ï¼ˆJSONæ ¼å¼ï¼‰
- æ•°æ®åº“æ–‡ä»¶ï¼ˆSQLiteæ ¼å¼ï¼‰
- è¿è¡Œä¸­çš„SGLangæœåŠ¡å™¨

### 2. å¯åŠ¨SGLangæœåŠ¡å™¨

```bash
# å¯åŠ¨SGLangæœåŠ¡å™¨ï¼ˆç¤ºä¾‹ï¼‰
python -m sglang.launch_server \
    --model-path /path/to/your/model \
    --host 0.0.0.0 \
    --port 30000
```

### 3. è¿è¡Œè¯„ä¼°

```bash
# åŸºç¡€è¯„ä¼°ï¼ˆå•è½¨è¿¹ï¼‰
python main_eval.py \
    --dataset_path spider_data/filter_test.json \
    --db_root_path spider_data \
    --server_url http://localhost:30000

# å¤šè½¨è¿¹è¯„ä¼°
python main_eval.py \
    --dataset_path spider_data/filter_test.json \
    --db_root_path spider_data \
    --server_url http://localhost:30000 \
    --n 5 \
    --temperature 0.8 \
    --model_name "qwen2.5-7b-instruct"
```

## å‘½ä»¤è¡Œå‚æ•°

### å¿…éœ€å‚æ•°

- `--dataset_path`: è¯„ä¼°æ•°æ®é›†æ–‡ä»¶è·¯å¾„
- `--db_root_path`: æ•°æ®åº“æ–‡ä»¶æ ¹ç›®å½•
- `--server_url`: SGLangæœåŠ¡å™¨URL

### æ ¸å¿ƒå‚æ•°

- `--n`: æ¯ä¸ªæ ·æœ¬ç”Ÿæˆçš„è½¨è¿¹æ•°é‡ï¼ˆé»˜è®¤ï¼š1ï¼‰
- `--model_name`: æ¨¡å‹åç§°ï¼ˆé»˜è®¤ï¼šqwen2.5-7b-instructï¼‰
- `--temperature`: æ¸©åº¦ç³»æ•°ï¼ˆé»˜è®¤ï¼š0.6ï¼‰
- `--max_tokens`: æœ€å¤§tokenæ•°ï¼ˆé»˜è®¤ï¼š30000ï¼‰
- `--stream`: æ˜¯å¦å¯ç”¨æµå¼è¾“å‡ºï¼ˆé»˜è®¤ï¼šFalseï¼‰

### å…¶ä»–å‚æ•°

- `--output_dir`: ç»“æœè¾“å‡ºç›®å½•ï¼ˆé»˜è®¤ï¼š./resultsï¼‰
- `--sample_size`: è¯„ä¼°æ ·æœ¬æ•°é‡ï¼ˆé»˜è®¤ï¼šå…¨éƒ¨ï¼‰
- `--max_turns`: æœ€å¤§å¯¹è¯è½®æ•°ï¼ˆé»˜è®¤ï¼š6ï¼‰
- `--concurrent_requests`: å¹¶å‘è¯·æ±‚æ•°ï¼ˆé»˜è®¤ï¼š5ï¼‰
- `--conversation_timeout`: å¯¹è¯è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ï¼š300ç§’ï¼‰
- `--log_level`: æ—¥å¿—çº§åˆ«ï¼ˆé»˜è®¤ï¼šERRORï¼‰

## å¤šè½¨è¿¹åŠŸèƒ½

### æ¦‚å¿µè¯´æ˜

- **è½¨è¿¹**: å¯¹äºåŒä¸€ä¸ªé—®é¢˜ï¼Œæ¨¡å‹ç”Ÿæˆçš„ä¸€æ¬¡å®Œæ•´å¯¹è¯è¿‡ç¨‹
- **æ ·æœ¬çº§åˆ«å‡†ç¡®ç‡**: åœ¨næ¡è½¨è¿¹ä¸­ï¼Œåªè¦æœ‰ä¸€æ¡è½¨è¿¹æ­£ç¡®ï¼Œè¯¥æ ·æœ¬å°±ç®—æ­£ç¡®
- **è½¨è¿¹çº§åˆ«å‡†ç¡®ç‡**: æ‰€æœ‰è½¨è¿¹çš„å¹³å‡æ­£ç¡®ç‡

### ä½¿ç”¨ç¤ºä¾‹

```bash
# ç”Ÿæˆ3æ¡è½¨è¿¹ï¼Œä½¿ç”¨è¾ƒé«˜æ¸©åº¦å¢åŠ å¤šæ ·æ€§
python main_eval.py \
    --dataset_path spider_data/filter_test.json \
    --db_root_path spider_data \
    --server_url http://localhost:30000 \
    --n 3 \
    --temperature 0.8

# ç”Ÿæˆ5æ¡è½¨è¿¹ï¼Œä½¿ç”¨ä¸åŒæ¨¡å‹
python main_eval.py \
    --dataset_path spider_data/filter_test.json \
    --db_root_path spider_data \
    --server_url http://localhost:30000 \
    --n 5 \
    --model_name "your_model_name" \
    --temperature 0.7 \
    --max_tokens 20000
```

## æ•°æ®æ ¼å¼

### è¯„ä¼°æ•°æ®é›†æ ¼å¼

```json
[
  {
    "id": "sample_1",
    "question": "How many users are there in the database?",
    "db_id": "company_db",
    "data_source": "spider",
    "ground_truth_sql": "SELECT COUNT(*) FROM users;",
    "difficulty": "easy"
  }
]
```

### ç›®å½•ç»“æ„

```
db_root_path/
â”œâ”€â”€ test_database/
â”‚   â””â”€â”€ company_db/
â”‚       â”œâ”€â”€ schema.sql
â”‚       â””â”€â”€ company_db.sqlite
```

## è¾“å‡ºç»“æœ

### è¾“å‡ºæ–‡ä»¶

è¿è¡Œå®Œæˆåï¼Œä¼šåœ¨è¾“å‡ºç›®å½•ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

- `raw_results_YYYYMMDD_HHMMSS.json`: åŸå§‹è¯„ä¼°ç»“æœï¼ˆåŒ…å«æ‰€æœ‰è½¨è¿¹ï¼‰
- `analysis_YYYYMMDD_HHMMSS.json`: è¯¦ç»†åˆ†æç»“æœ
- `report_YYYYMMDD_HHMMSS.txt`: äººç±»å¯è¯»çš„è¯„ä¼°æŠ¥å‘Š

### è¯„ä¼°æŒ‡æ ‡

#### å¤šè½¨è¿¹æŒ‡æ ‡

- **æ ·æœ¬çº§åˆ«å‡†ç¡®ç‡**: åªè¦æœ‰ä¸€æ¡è½¨è¿¹æ­£ç¡®å°±ç®—æ ·æœ¬æ­£ç¡®
- **è½¨è¿¹çº§åˆ«å‡†ç¡®ç‡**: æ‰€æœ‰è½¨è¿¹çš„å¹³å‡æ­£ç¡®ç‡
- **å¹³å‡è½¨è¿¹æ•°**: æ¯ä¸ªæ ·æœ¬çš„å¹³å‡è½¨è¿¹æ•°é‡

#### ä¼ ç»ŸæŒ‡æ ‡

- **SQLæå–ç‡**: ä»æ¨¡å‹å“åº”ä¸­æˆåŠŸæå–SQLçš„æ¯”ä¾‹
- **SQLæœ‰æ•ˆæ€§**: æå–çš„SQLè¯­æ³•æ˜¯å¦æ­£ç¡®
- **æ‰§è¡ŒæˆåŠŸç‡**: SQLæŸ¥è¯¢æ‰§è¡ŒæˆåŠŸçš„æ¯”ä¾‹

### ç¤ºä¾‹è¾“å‡º

```
============================================================
EVALUATION SUMMARY
============================================================
Run ID: 20250710_140000
Total Samples: 100
Total Trajectories: 500
Avg Trajectories per Sample: 5.00
Sample-level Accuracy: 0.8500
Trajectory-level Accuracy: 0.6200
SQL Extraction Rate: 0.9800
Results saved to: ./results
============================================================
```

## æ•°æ®å‡†å¤‡å·¥å…·

### è¿‡æ»¤æµ‹è¯•æ•°æ®

ä½¿ç”¨ `filter_test_data.py` è„šæœ¬è¿‡æ»¤æµ‹è¯•æ•°æ®ï¼š

```bash
python filter_test_data.py \
    --input_file spider_data/test.json \
    --output_file spider_data/filter_test.json \
    --db_path spider_data/test_database
```

è¯¥è„šæœ¬ä¼šï¼š
1. æ£€æŸ¥æ¯ä¸ªæ ·æœ¬å¯¹åº”çš„æ•°æ®åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨
2. è¿‡æ»¤æ‰ç¼ºå°‘ `schema.sql` æˆ– `*.sqlite` æ–‡ä»¶çš„æ ·æœ¬
3. ä¿å­˜è¿‡æ»¤åçš„æ•°æ®é›†

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“æ–‡ä»¶æœªæ‰¾åˆ°**
   - ä½¿ç”¨ `filter_test_data.py` æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
   - ç¡®è®¤æ•°æ®åº“æ–‡ä»¶è·¯å¾„æ­£ç¡®

2. **SGLangæœåŠ¡å™¨è¿æ¥å¤±è´¥**
   - æ£€æŸ¥æœåŠ¡å™¨URLå’Œç«¯å£
   - ç¡®è®¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ

3. **å¤šè½¨è¿¹è¯„ä¼°ç¼“æ…¢**
   - å‡å°‘ `--n` å‚æ•°å€¼
   - å¢åŠ  `--concurrent_requests` å‚æ•°
   - é™ä½ `--temperature` å‡å°‘ç”Ÿæˆæ—¶é—´

### è°ƒè¯•æ–¹æ³•

```bash
# å¯ç”¨DEBUGæ—¥å¿—
python main_eval.py --log_level DEBUG [å…¶ä»–å‚æ•°]

# å°æ ·æœ¬æµ‹è¯•
python main_eval.py --sample_size 5 --n 2 [å…¶ä»–å‚æ•°]

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
tail -f sql_eval.log
```

## æ€§èƒ½ä¼˜åŒ–

### å¤šè½¨è¿¹ä¼˜åŒ–

- æ ¹æ®éœ€æ±‚è°ƒæ•´è½¨è¿¹æ•°é‡ï¼ˆ--nï¼‰
- ä½¿ç”¨é€‚å½“çš„æ¸©åº¦å‚æ•°å¹³è¡¡å¤šæ ·æ€§å’Œè´¨é‡
- ç›‘æ§æ€»è½¨è¿¹æ•°é‡ä»¥æ§åˆ¶è¯„ä¼°æ—¶é—´

### å¹¶å‘è°ƒä¼˜

- æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´ `--concurrent_requests`
- è€ƒè™‘è½¨è¿¹æ•°é‡å¯¹å¹¶å‘çš„å½±å“
- ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

## é¡¹ç›®ç»“æ„

```
sql_eval/
â”œâ”€â”€ main_eval.py              # ä¸»è¯„ä¼°è„šæœ¬
â”œâ”€â”€ conversation_manager.py   # å¯¹è¯ç®¡ç†
â”œâ”€â”€ data_preprocess.py        # æ•°æ®é¢„å¤„ç†
â”œâ”€â”€ evaluator.py             # è¯„ä¼°å™¨
â”œâ”€â”€ result_analyzer.py       # ç»“æœåˆ†æ
â”œâ”€â”€ tool_client.py           # SQLå·¥å…·å®¢æˆ·ç«¯
â”œâ”€â”€ filter_test_data.py      # æ•°æ®è¿‡æ»¤å·¥å…·
â”œâ”€â”€ requirements.txt         # ä¾èµ–åˆ—è¡¨
â””â”€â”€ README.md               # æ–‡æ¡£
```
